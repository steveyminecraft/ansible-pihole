name: CI

on:
  push:
    branches:
      - dev
      - master
      - "feature/**"
  pull_request:
    branches:
      - dev
      - master
  workflow_dispatch:

env:
  python_version: 3.12

jobs:
  lint:
    name: Ansible & YAML lint
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install -r collections/requirements.yml        

      - name: Install Ansible roles
        run: |
          ansible-galaxy role install -r roles/requirements.yml

      # ansible-lint via official action
      - name: Run ansible-lint
        uses: ansible/ansible-lint@v25.12.0
        with:
          # requirements_file: requirements.yml
          working_directory: .

      # yamllint via pip (quick + simple)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.python_version }}

  ansible-tests-ubuntu:
    name: Ansible syntax & dry-run
    runs-on: ubuntu-24.04
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Show Ansible version
        run: ansible --version

      # 1) Syntax-check all main playbooks
      - name: Syntax check playbooks
        run: |
          ansible-playbook -i inventory/ci/hosts.ini playbooks/bootstrap-pihole.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/update-pihole.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/keepalived.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/sync.yaml --syntax-check

      # 2) Optional: safe dry-run of a “happy path” bootstrap
      - name: Check-mode converge (bootstrap)
        run: |
          ansible-playbook -i inventory/ci/hosts.ini tests/ci-bootstrap.yml --check