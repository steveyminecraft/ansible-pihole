name: CI

on:
  push:
    branches:
      - dev
      - master
      - "feature/**"
  pull_request:
    branches:
      - dev
      - master
  workflow_dispatch:

env:
  python_version: 3.12

jobs:
  lint:
    name: Ansible & YAML lint
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ansible-lint via official action
      - name: Run ansible-lint
        uses: ansible/ansible-lint@v25.5.0
        with:
          # requirements_file: requirements.yml
          working_directory: .

      # yamllint via pip (quick + simple)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.python_version }}

      - name: Install yamllint
        run: pip install yamllint

      - name: Run yamllint
        run: yamllint .
        # You can add a .yamllint config later if you want to tune rules

  ansible-tests-ubuntu:
    name: Ansible syntax & dry-run
    runs-on: ubuntu-24.04
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Show Ansible version
        run: ansible --version

      # 1) Syntax-check all main playbooks
      - name: Syntax check playbooks
        run: |
          ansible-playbook -i inventory/ci/hosts.ini playbooks/bootstrap-pihole.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/update-pihole.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/keepalived.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/sync.yaml --syntax-check

      # 2) Optional: safe dry-run of a “happy path” bootstrap
      - name: Check-mode converge (bootstrap)
        run: |
          ansible-playbook -i inventory/ci/hosts.ini tests/ci-bootstrap.yml --check

  ansible-tests-rocky:
    name: Rocky Linux 10 – Ansible sanity
    runs-on: ubuntu-24.04

    # The *job* runs inside this container image
    container:
      image: docker pull rockylinux/rockylinux:10.1.20251123
    # or your own image if 10 isn't published yet

    steps:
      - name: Install Git (container is very minimal)
        run: |
          yum -y install git

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python + pip
        run: |
          yum -y install python3 python3-pip
          python3 -m pip install --upgrade pip

      - name: Install Ansible
        run: |
          python3 -m pip install --upgrade pip
          pip install ansible

      - name: Install role & collection dependencies
        run: |
          ansible-galaxy install -r roles/requirements.yml
          ansible-galaxy collection install -r roles/requirements.yml

      - name: Show Ansible version
        run: ansible --version

      - name: Run CI playbook against localhost
        run: |
          ansible-playbook \
            -i 'localhost,' \
            -c local \
            tests/ci-bootstrap.yml \
            --check