name: CI

on:
  push:
    branches:
      - dev
      - master
      - "feature/**"
  pull_request:
    branches:
      - dev
      - master
  workflow_dispatch:

env:
  python_version: 3.12

jobs:
  lint:
    name: Ansible & YAML lint
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Debug git ref + files
        run: |
          echo "github.ref=$GITHUB_REF"
          echo "github.sha=$GITHUB_SHA"
          git status --porcelain || true
          git rev-parse --abbrev-ref HEAD || true
          git log -1 --oneline || true
          ls -la
          ls -la collections || true
          find . -maxdepth 3 -type f -name 'requirements.yml' -print

      - name: Install ansible-lint
        run: |
          python -m pip install --upgrade pip
          pip install ansible-lint

      - name: Install Ansible collections (optional)
        if: hashFiles('collections/requirements.yml') != ''
        run: |
          ansible-galaxy collection install -r collections/requirements.yml -p ./collections

      - name: Install Ansible roles (optional)
        if: hashFiles('roles/requirements.yml') != ''
        run: |
          ansible-galaxy role install -r roles/requirements.yml -p ./roles

      - name: Run ansible-lint
        env:
          ANSIBLE_COLLECTIONS_PATHS: ${{ github.workspace }}/collections
          ANSIBLE_ROLES_PATH: ${{ github.workspace }}/roles
        run: |
          ansible-lint --version
          ansible-lint


  ansible-tests-ubuntu:
    name: Ansible syntax & dry-run
    runs-on: ubuntu-24.04
    needs: lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Show Ansible version
        run: ansible --version

      # 1) Syntax-check all main playbooks
      - name: Syntax check playbooks
        run: |
          ansible-playbook -i inventory/ci/hosts.ini playbooks/bootstrap-pihole.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/update-pihole.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/keepalived.yaml --syntax-check
          ansible-playbook -i inventory/ci/hosts.ini playbooks/sync.yaml --syntax-check

      # 2) Optional: safe dry-run of a “happy path” bootstrap
      - name: Check-mode converge (bootstrap)
        run: |
          ansible-playbook -i inventory/ci/hosts.ini tests/ci-bootstrap.yml --check